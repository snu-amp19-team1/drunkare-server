<!-- demo template comes here -->
{% load static %}
<!DOCTYPE html>
<html class="uk-height-1-1">
    <head>
        <title>Drunkare-demo</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'css/uikit.css'%}" />
        <script src="{% static 'js/uikit.min.js'%}"></script>
        <script src="{% static 'js/uikit-icons.min.js'%}"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
        <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    </head>
    <body class="uk-height-1-1">
        <div class="uk-grid-collapse uk-child-width-expand@s uk-text-center uk-height-1-1" uk-grid>
            <div class="uk-width-1-2 uk-background-muted uk-height-1-1">
                <!-- User 1 -->
		<div class="uk-margin-top uk-background-muted">
                  <h1><span uk-icon="icon: location; ratio: 3"></span><span class="uk-heading-small" style="font-weight:bold" id="location1"></span></h1>
                </div>
                <div class="uk-margin-top uk-background-muted" style="height: 60%">
                  <canvas id="user1"></canvas>
                </div>  
                <div class="uk-padding-small uk-background-muted">
                    <h1><span class="uk-heading-medium uk-text-primary">{{ user1.user_name }} is in the<br>"<span id="context1"></span>" context</span></h1>
                    <h5 class="uk-heading-line"><span id="time1" class="uk-text-primary">- Updated</span></h5>
                </div>
            </div>
            <div class="uk-width-1-2 uk-background-primary uk-height-1-1">
                <!-- User 2 -->
		<div class="uk-margin-top uk-background-primary uk-light">
                  <h1><span uk-icon="icon: location; ratio: 3"></span><span class="uk-heading-small uk-text-primary" style="font-weight:bold" id="location2"></span></h1>
                </div>
                <div class="uk-margin-top uk-background-primary" style="height: 60%">
                  <canvas id="user2"></canvas>
                </div>
                <div class="uk-padding-small uk-light uk-background-primary">
                    <h1><span class="uk-heading-medium">{{ user2.user_name }} is in the<br>"<span id="context2"></span>" context</span></h1>
                    <h5 class="uk-heading-line"><span id="time2" class="uk-text-primary">- Updated</span></h5>
                </div>
            </div>
        </div>
        <script>
            /* ======= make chart ======= */
            var activity_labels = {{ activity_labels|safe }};
            updateResult();
            /* =============================== */


            
            /* ======= update chart ======= */
            setInterval(updateResult, 10000); // update period

            // function
            var chart1;
            var chart2;

            function updateResult() {
                $.get('/custom_user/fetch', function(data) {
                    users = JSON.parse(data['users']);
                    user1 = users[0]['fields'];
                    user2 = users[1]['fields'];
                    updated_chart_data1 = JSON.parse(user1['recent_activities']);
                    user_data1 = {
                        labels: activity_labels,
                        datasets: [{
                            backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850","#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850",
                                            "#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#36a2eb","#ff6384"],
                            borderColor: 'transparent',
                            data: updated_chart_data1
                        }]
                    }
                    updated_chart_data2 = JSON.parse(user2['recent_activities']);
                    user_data2 = {
                        labels: activity_labels,
                        datasets: [{
                            backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850","#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850",
                                            "#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#36a2eb","#ff6384"],
                            borderColor: 'transparent',
                            data: updated_chart_data2
                        }]
                    }

                    // clear canvas
                    canvas1 = document.getElementById('user1');
                    ctx1 = canvas1.getContext('2d');
                    ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
                    if (chart1){
                        chart1.destroy();
                    }

                    canvas2 = document.getElementById('user2');
                    ctx2 = canvas2.getContext('2d');
                    ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
                    if (chart2){
                        chart2.destroy();
                    }

                    // rerender chart
                    chart1 = new Chart(ctx1, {
                        type: 'pie',
                        data: user_data1,
                        options: {
                            legend: {
                            display: false
                            },
                            tooltips: {
                            bodyFontSize: 30,
                            bodyFontFamily: 'Karla'
                            },
                            responsive:true,
                            maintainAspectRatio: false
                        }
                    });
                    chart2 = new Chart(ctx2, {
                        type: 'pie',
                        data: user_data2,
                        options: {
                            legend: {
                            display: false
                            },
                            tooltips: {
                            bodyFontSize: 30,
                            bodyFontFamily: 'Karla'
                            },
                            responsive:true,
                            maintainAspectRatio: false
                        }
                    });

                    //update strings
                    time1=new Date(user1['last_update']).toString();
                    $("#time1").text(String(time1).substring(0,time1.length-17) + " Updated");
                    time2=new Date(user2['last_update']).toString();
                    $("#time2").text(String(time2).substring(0,time2.length-17) + " Updated");
                    
                    if (user1['current_context'] == "drinking"){
                        $("#context1").css('font-weight','Bold');
                        $("#context1").css('color','red');
                    }
                    else{
                        $("#context1").css('font-weight','');
                        $("#context1").css('color','#1E87F0');
                    }
                    if (user2['current_context'] == "drinking"){
                        $("#context2").css('font-weight','Bold');
                        $("#context2").css('color','red');
                    }
                    else{
                        $("#context2").css('font-weight','');
                        $("#context2").css('color','white');
                    }
                    $("#context1").text(user1['current_context']); 
                    $("#context2").text(user2['current_context']); 

		    $("#location1").text(user1['current_location']);
		    $("#location2").text(user2['current_location']);

                    console.log(user1['current_location'])
                    console.log(user2['current_location'])
                });
            }
            /* =============================== */
            

        </script>
    </body>
</html>
